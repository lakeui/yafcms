/* 
 AutocJS - Simple & Fast to create a table of contents menu for your article. 
 Copyright (c) 2016 yaohaixiao, all right reserved. 
 homepage: https://github.com/yaohaixiao/AutocJS/#readme 
 version: 0.2.2 
 author: yaohaixiao  
 license: MIT 
 */
!function(a,b){"use strict";"function"==typeof define&&define.amd?define("autocjs",["jquery"],b(a,$)):"function"==typeof define&&define.cmd?define("autocjs",function(c,d,e){e.exports=b(a,c("jquery"))}):"object"==typeof exports?module.exports=b(a,require("jquery")):b(a,jQuery)}("undefined"!=typeof window?window:this,function(a,b){"use strict";function c(a){return a.replace(new RegExp(j,"img"),"")}function d(a){return a.replace(/[\r\t\n]/g," ").replace(/[&<>"'\/`]/g,function(a){return i[a]})}function e(a){return a.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#x27;/g,"'").replace(/&#x2F;/g,"/").replace(/&#x60;/g,"`")}function f(a){return e(d(c(a)))}function g(a){var b,c=a.data,d=a.html,e=a.startTag||"{",g=a.endTag||"}";d+="";for(b in c)d=d.replace(new RegExp(e+b+g,"img"),f(c[b]));return f(d)}function h(a){return k+=1,a?a+"-"+k:k}var i={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;","`":"&#x60;"},j="<script[^>]*>([\\S\\s]*?)</script\\s*>",k=-1,l="autocjs-show",m="autocjs-hide",n="autocjs-title",o="autocjs-anchor",p="autocjs-subjects",q="autocjs-chapter",r="autocjs-text",s="autocjs-index",t='<a class="'+o+'" aria-hidden="true"></a>',u='<div class="autocjs '+m+'" aria-hidden="true"></div>',v='<h3 class="autocjs-hd" aria-hidden="true">{title}</h3>',w='<div class="autocjs-bar" aria-hidden="true"></div>',x='<h2 class="autocjs-switch" title="Toggle Menu" aria-hidden="true">&#926;</h2>',y='<a class="autocjs-top" href="#top" aria-hidden="true">TOP</a>',z='<nav class="autocjs-bd" aria-hidden="true"></nav>',A='<ol class="autocjs-chapters" aria-hidden="true"></ol>',B='<ol class="'+p+'" aria-hidden="true"></ol>',C='<li class="'+q+'" aria-hidden="true"></li>',D='<a class="'+r+'" aria-hidden="true"></a>',E='<em class="'+s+'" aria-hidden="true"></em>',F='<div class="autocjs-overlay '+m+'" aria-hidden="true"></div>',G="h1,h2,h3,h4,h5,h6",H=n,I=function(a){return this.attributes={},this.elements={article:null,wrap:null,title:null,bar:null,switch:null,top:null,body:null,list:null,overlay:null},this.data={anchors:[],chapters:[],list:[]},this.set(I.defaults),b.isPlainObject(a)&&this.init(a),this};return I.defaults={article:"#article",selector:G,prefix:H,title:"Table of Contents",isAnimateScroll:!0,onlyAnchors:!1,showTocInArticle:!1,showIndexAtAnchors:!1,ANCHOR_LINK:t,WRAP:u,TITLE:v,BAR:w,SWITCH:x,TOP:y,BODY:z,LIST:A,SUB_LIST:B,ITEM:C,LINK:D,CHAPTER:E,OVERLAY:F},I.prototype={version:"0.2.2",constructor:I,set:function(a){return b.isPlainObject(a)&&b.extend(this.attributes,a),this},get:function(a){return this.attributes[a]},anchors:function(a){return b.isArray(a)?(this.data.anchors=a,this):this.data.anchors},chapters:function(a){return b.isPlainObject(a)?(this.data.chapters=a,this):this.data.chapters},getArticleAnchors:function(){return this.elements.article.find(this.get("selector"))},getArticleChapters:function(){var a=this,c=[],d=1,e=0,f=this.get("prefix");return b(this.getArticleAnchors()).each(function(g,i){var j=h(f),k=b(i),l=k.html(),m=parseInt(k[0].tagName.toUpperCase().replace(/[H]/gi,""),10),n=-1;m>d?(e+=1,n=1===e?-1:g-1):m===d||m<d&&m>e?1===m?(e=1,n=-1):n=c[g-1].pid:m<=e&&(1===m?e=1:e-=d-m,n=1===e?-1:a.getPidByDiffer(c,d-m,g)),d=m,c.push({id:g,level:e,text:l,value:j,tag:i.tagName,pid:n})}),c},getChaptersDataList:function(){var a=this.chapters(),c={},d=[];return b(a).each(function(a,b){var d=b.pid===-1?"H1":b.pid.toString();c[d]||(c[d]=[])}),b.each(c,function(e){b(a).each(function(a,b){var d=b.pid===-1?"H1":b.pid.toString();e===d&&c[e].push(b)}),d.push(c[e])}),d},getChapterIndex:function(a){var c=-1;return b(this.getChaptersDataList()).each(function(d,e){b(e).each(function(b,d){if(d===a)return c=b,!1})}),c},getPidByDiffer:function(a,b,c){var d=-1;switch(b){case 1:d=a[a[c-1].pid].pid;break;case 2:d=a[a[a[c-1].pid].pid].pid;break;case 3:d=a[a[a[a[c-1].pid].pid].pid].pid;break;case 4:d=a[a[a[a[a[c-1].pid].pid].pid].pid].pid;break;case 5:d=a[a[a[a[a[a[c-1].pid].pid].pid].pid].pid].pid;break;default:d=a[a[c-1].pid].pid}return d},init:function(a){return b.isPlainObject(a)&&this.set(a),this._init().render()._attachEvents(),this},_init:function(){var a=this,c=this.elements;return c.article=b(this.get("article")),c.wrap=b(this.get("WRAP")),c.title=b(g({data:{title:a.get("title")},html:a.get("TITLE")})),c.bar=b(this.get("BAR")),c.switch=b(this.get("SWITCH")),c.top=b(this.get("TOP")),c.body=b(this.get("BODY")),c.list=b(this.get("LIST")),c.overlay=b(this.get("OVERLAY")),this.data.anchors=this.getArticleAnchors(),this.data.chapters=this.getArticleChapters(),this.data.list=this.getChaptersDataList(),this},reload:function(a){return b.isPlainObject(a)&&this.set(a),this._init().render(),this},render:function(){return this.renderTocInArticle().renderAnchors().renderToc(),this},renderTocInArticle:function(){var a=this.get("showTocInArticle"),c=b(this.elements.article[0].firstChild),d=b(this.get("LIST"));return a&&(d.insertBefore(c),this.renderChapters(d)),this},renderAnchors:function(){var a=this,c=this.anchors(),d=this.chapters();return b(d).each(function(d,e){var f=b(c[d]),g=b(a.get("ANCHOR_LINK")).attr({href:"#autocjs-title-"+e.id,"aria-label":e.text}).addClass(o).addClass(m),h=e.value;f.attr("id",h).addClass(n).append(g),a.renderAnchorIndex(e)}),this},renderAnchorIndex:function(a){var c,d,e,f=a.pid,g=a.id,h=a.tag,i=this.get("showIndexAtAnchors"),j=b("#"+n+"-"+g),k="article-";return i&&"H1"!==h&&(c=b(this.get("CHAPTER")).attr("id",k+s+"-"+g),e=this.getChapterIndex(a)+1,d=f===-1&&"H2"===h?e:b("#"+k+s+"-"+f).html()+"."+e,c.html(d),c.insertBefore(j[0].firstChild)),this},renderToc:function(){var a=this.get("onlyAnchors");return a||(this.renderElements().renderChapters(),this.elements.wrap.removeClass(m),this.updateLayout()),this},renderElements:function(){var a=this.elements,c=b(document.body),d=this.get("isAnimateScroll");return a.bar.append(a.switch).append(a.top),a.body.append(a.list),a.wrap.append(a.title).append(a.body).append(a.bar),c.append(a.wrap).append(a.overlay),d||c.attr("id","top"),this},renderChapters:function(a){var c=this,d=a?b(a):this.elements.list,e=this.chapters();return d.empty(),b(e).each(function(e,f){var g,h,i,j,k=f.pid,l=f.id,m=null,n=b(c.get("ITEM")),o=b(c.get("CHAPTER")),t=b(c.get("LINK")),u=b("#"+p+"-"+k),v="",w=0,x="article-";a?(g=x+r+"-"+l,h=x+q+"-"+l,i=x+p+"-"+k,j=x+q+"-"+k):(g=r+"-"+l,h=q+"-"+l,i=p+"-"+k,j=q+"-"+k),t.attr({id:g,href:"#"+f.value,rel:f.value}).html(f.text),n.attr({id:h,title:f.text}).append(t),f.pid===-1?(d.append(n),w=n.index()+1,v=w):(m=b("#"+j),u[0]||(u=b(c.get("SUB_LIST")).attr("id",i),m.append(u)),u.append(n),w=n.index()+1,v=m.find("."+s).html()+"."+w),o.attr("data-chapter",w).html(v),o.insertBefore(t)}),this},show:function(){var a=this.elements,b=a.wrap;return a.overlay.removeClass(m),b.animate({left:0},150,function(){b.addClass(l)}),this},hide:function(){var a=this.elements,b=a.wrap;return b.animate({left:-300},150,function(){a.overlay.addClass(m),b.removeClass(l)}),this},toggle:function(){return this.elements.wrap.hasClass(l)?this.hide():this.show(),this},updateLayout:function(){var a=this.elements,b=a.wrap[0].offsetHeight,c=a.title[0].offsetHeight;return a.body.height(b-c),this},scrollTo:function(a){var c=this;return b("html,body").animate({scrollTop:a},500,"linear",function(){c.hide()}),this},_attachEvents:function(){var c=this,d=this.elements,e=d.article,f={context:c},g=this.get("onlyAnchors");return e.delegate("."+n,"mouseenter",f,this._onAutocJSAnchorMouseEnter),e.delegate("."+n,"mouseleave",f,this._onAutocJSAnchorMouseLeave),g||(d.switch.on("click",f,this._onSwitchClick),d.top.on("click",f,this._onTopClick),d.list.delegate("."+r,"click",f,this._onChapterClick),d.overlay.on("click",f,this._onOverlayClick),b(a).on("resize",f,this._onWindowResize)),this},_onAutocJSAnchorMouseEnter:function(a){var c=a.data.context,d=b(this).find("."+o);return d.removeClass(m),c},_onAutocJSAnchorMouseLeave:function(a){var c=a.data.context,d=b(this).find("."+o);return d.addClass(m),c},_onSwitchClick:function(a){var b=a.data.context;return b.toggle(),a.stopPropagation(),a.preventDefault(),b},_onTopClick:function(a){var b=a.data.context,c=b.get("isAnimateScroll");return c?(b.scrollTo(0),a.stopPropagation(),a.preventDefault()):b.hide(),b},_onChapterClick:function(a){var c=a.data.context,d=c.get("isAnimateScroll"),e=b("#"+b(this).attr("rel"));return d?(c.scrollTo(e[0].offsetTop),a.stopPropagation(),a.preventDefault()):c.hide(),c},_onOverlayClick:function(a){var b=a.data.context;return b.hide(),a.stopPropagation(),a.preventDefault(),b},_onWindowResize:function(a){var b=a.data.context;return b.updateLayout(),b}},b.extend(b.fn,{autoc:function(a){var c=b(this);return new I(b.extend({},a,{article:c}))}}),a.AutocJS=I,I});